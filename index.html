<!DOCTYPE html>
<html>
  <head>
    <title>農地</title>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.1/leaflet.css">
    <script src="//cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>
    <script src="leaflet.groupedlayercontrol.min.js"></script>
    <link rel="stylesheet" href="leaflet.groupedlayercontrol.min.css"/>
    <script src="GIBSMetadata.js"></script>
    <script src="GIBSLayer.js"></script>
    <style>
      body { margin: 0; padding: 0; }
      html, body, #map { height: 100%; width: 100%; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // (equatorial) R = 6378137m in WGS84
      var m2d125Y = 0.0022457882102988034
      var m2d125X = 0.002470367031328684
      var labels = {
        'CUAR_OVER': '銅',
        'ZNAR_OVER': '鋅',
        'CDAR_OVER': '鉻',
        'CRAR_OVER': '鎘',
        'NIAR_OVER': '鎳',
        'PBAR_OVER': '鉛',
      }
      function GoogleLayer () {
        return L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
          maxZoom: 20,
          subdomains:['mt0','mt1','mt2','mt3']
        })
      }
      function GIBSLayer () {
        return new L.GIBSLayer('MODIS_Aqua_CorrectedReflectance_TrueColor', {
          date: new Date('2015/04/01'),
          transparent: true
        })
      }
      function osmLayer () {
        return L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        });
      }

      function SGWLayer (prop) {
        prop = prop || {}
        var filter = (prop.restricted ?
            d => d.GeoJSON && d['場址列管狀態'] === '公告為控制場址'
            : d => d.GeoJSON)
        var layer = L.featureGroup()
        layer.load = () => {
          d3.csv('data/sgw-epa-geom.csv', data => {
            data
              .filter(filter)
              .forEach(d => {
                L.geoJson(JSON.parse(d.GeoJSON), {
                    style: () => ({ color: prop.color || '#f00', weight: 1 }),
                    onEachFeature: (feature, layer) => {
                      layer.bindPopup(d['縣市別'] + d['場址名稱'] + '<div>' + d['土壤/地下水污染物'] + '</div><div>' + d['污染情形'] + '</div><div>公告為控制場址 ' + d['公告為控制場址日期'] + '</div><div>公告解除控制場址 ' + d['公告解除控制場址日期'] + '</div>')
                    }
                  }).addTo(layer)
              })
          })
        }
        return layer
      }

      function TARILayer (prop) {
        var prop = prop || {}
        var filter = (prop.restricted === true ?
            d => d.RESTRICTED === '1'
            : (prop.restricted === false ?
              d => d.RESTRICTED === '0'
              : d => true))
        var layer = L.featureGroup()
        layer.load = () => {
          d3.csv('data/tari-soil-over.csv', data => {
            data
              .filter(filter)
              .forEach(d => {
                L.rectangle([[d.Y - m2d125Y, d.X - m2d125X], [d.Y + m2d125Y, d.X + m2d125X]], {
                  weight: 1,
                  color: prop.color || '#ff0',
                  opacity: prop.opacity || 0.8
                })
                  .bindPopup(d.YEAR + ' 年農試所檢測重金屬超標 ' + ['CUAR_OVER', 'ZNAR_OVER', 'CDAR_OVER', 'CRAR_OVER', 'NIAR_OVER', 'PBAR_OVER'].filter(n => d[n] === '1').map(n => labels[n]).join(' '))
                  .addTo(layer)
              })
          })
        }
        return layer
      }

      var baseLayers = {
        'OpenStreetMap': osmLayer(),
        'Google Satellite': GoogleLayer(),
        'NASA': GIBSLayer()
      }
      var overlays = {
        '環保署農地列管': {
          '解除列管': SGWLayer({ color: '#00f' }),
          '列管中': SGWLayer({ restricted: true, color: '#f00' }),
        },
        '農試所土壤調查': {
          '具污染潛勢': TARILayer({ opacity: 0.3 }),
        },
        '綜合結果': {
          '具污染潛勢而未列管': TARILayer({ restricted: false, opacity: 0.8 })
        }
      }

      function addLayerControl () {
        return function () {
          var map = this
          L.control.groupedLayers(baseLayers, overlays, {
            collapsed: false
          }).addTo(map)
        }
      }

      var map = L.map('map')
        .addLayer(baseLayers['OpenStreetMap'])
        .addLayer(baseLayers['Google Satellite'])
        .addLayer(overlays['環保署農地列管']['曾列管'])
        .addLayer(overlays['農試所土壤調查']['具污染潛勢'])
        .setView([24.47465, 120.72052], 8)
        .whenReady(addLayerControl())
        .whenReady(overlays['環保署農地列管']['曾列管'].load)
        .whenReady(overlays['環保署農地列管']['列管中'].load)
        .whenReady(overlays['農試所土壤調查']['具污染潛勢'].load)
        .whenReady(overlays['綜合結果']['具污染潛勢而未列管'].load)
    </script>
  </body>
</html>
