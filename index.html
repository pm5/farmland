<!DOCTYPE html>
<html>
  <head>
    <title>農地</title>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.1/leaflet.css">
    <script src="//cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>
    <style>
      body { margin: 0; padding: 0; }
      html, body, #map { height: 100%; width: 100%; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var labels = {
        'CUAR_OVER': '銅',
        'ZNAR_OVER': '鋅',
        'CDAR_OVER': '鉻',
        'CRAR_OVER': '鎘',
        'NIAR_OVER': '鎳',
        'PBAR_OVER': '鉛',
      }
      function osmLayer () {
        return L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        });
      }

      function SGWLayer () {
        var layer = L.featureGroup()
        layer.load = () => {
          d3.csv('data/sgw-epa-geom.csv', data => {
            data
              .filter(d => d.GeoJSON)
              .forEach(d => {
                L.geoJson(JSON.parse(d.GeoJSON), {
                    style: () => ({ color: '#f00' }),
                    onEachFeature: (feature, layer) => {
                      layer.bindPopup(d['縣市別'] + d['場址名稱'] + '<div>' + d['土壤/地下水污染物'] + '</div><div>' + d['污染情形'] + '</div><div>公告為控制場址 ' + d['公告為控制場址日期'] + '</div><div>公告解除控制場址 ' + d['公告解除控制場址日期'] + '</div>')
                    }
                  }).addTo(layer)
              })
          })
        }
        return layer
      }

      function TARILayer () {
        var layer = L.featureGroup()
        layer.load = () => {
          d3.csv('data/tari-soil-over.csv', data => {
            data
              .forEach(d => {
                L.circle([d.Y, d.X], 125)
                  .bindPopup(d.YEAR + ' 年檢測重金屬超標 ' + ['CUAR_OVER', 'ZNAR_OVER', 'CDAR_OVER', 'CRAR_OVER', 'NIAR_OVER', 'PBAR_OVER'].filter(n => d[n] === '1').map(n => labels[n]).join(' '))
                  .addTo(layer)
              })
          })
        }
        return layer
      }

      var baseLayers = {
        'OpenStreetMap': osmLayer()
      }
      var overlays = {
        '環保署': SGWLayer(),
        '農試所': TARILayer(),
      }

      function addLayerControl () {
        return function () {
          var map = this
          L.control.layers(baseLayers, overlays).addTo(map)
        }
      }

      var map = L.map('map')
        .addLayer(baseLayers['OpenStreetMap'])
        .addLayer(overlays['環保署'])
        .addLayer(overlays['農試所'])
        .setView([24.47465, 120.72052], 8)
        .whenReady(addLayerControl())
        .whenReady(overlays['環保署'].load)
        .whenReady(overlays['農試所'].load)
    </script>
  </body>
</html>
